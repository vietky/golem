<?xml version='1.1' encoding='UTF-8'?>
<project>
  <description>Automated deployment job for {{ app_name }} - Deploys from {{ git_repo }}</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>GIT_BRANCH</name>
          <description>Git branch to deploy</description>
          <defaultValue>{{ git_branch }}</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash
set -e

echo "Deploying {{ app_name }} from ${GIT_BRANCH} branch..."

# SSH command that creates directory structure and deploy script if needed
ssh -o StrictHostKeyChecking=no root@{{ ansible_host }} &lt;&lt;'DEPLOY_SCRIPT'
set -e

APP_NAME="{{ app_name }}"
APP_DIR="{{ app_dir }}"
APP_PORT="{{ app_port }}"
GIT_REPO="{{ git_repo }}"
GIT_BRANCH="${GIT_BRANCH:-{{ git_branch }}}"
JENKINS_HOME="{{ jenkins_home }}"
JENKINS_REPOS_DIR="{{ jenkins_repos_dir }}"
REPO_DIR="${JENKINS_REPOS_DIR}/${APP_NAME}"
SCRIPTS_DIR="${APP_DIR}/scripts"
LOG_DIR="${APP_DIR}/logs"
LOG_FILE="${LOG_DIR}/deploy-$(date +%Y%m%d-%H%M%S).log"

# Create directories
mkdir -p "${JENKINS_REPOS_DIR}"
mkdir -p "${SCRIPTS_DIR}"
mkdir -p "${LOG_DIR}"

# Clone or pull repository to Jenkins repos directory
echo "Cloning/pulling repository to ${REPO_DIR}..."
if [ ! -d "${REPO_DIR}/.git" ]; then
  echo "Cloning repository..."
  git clone -b "${GIT_BRANCH}" "${GIT_REPO}" "${REPO_DIR}"
else
  echo "Pulling latest changes..."
  cd "${REPO_DIR}" || exit 1
  git fetch origin
  git checkout "${GIT_BRANCH}" 2&gt;/dev/null || git checkout -b "${GIT_BRANCH}" "origin/${GIT_BRANCH}" || true
  git pull origin "${GIT_BRANCH}" || exit 1
fi

# Verify docker-compose.yml exists in repo
if [ ! -f "${REPO_DIR}/docker-compose.yml" ]; then
  echo "ERROR: docker-compose.yml not found in ${REPO_DIR}"
  exit 1
fi

# Create deploy.sh script if it doesn't exist
if [ ! -f "${SCRIPTS_DIR}/deploy.sh" ]; then
  cat &gt; "${SCRIPTS_DIR}/deploy.sh" &lt;&lt;'SCRIPT_EOF'
#!/bin/bash
set -e

APP_NAME="${APP_NAME:-golem-century}"
APP_DIR="${APP_DIR:-/opt/golem-century}"
APP_PORT="${APP_PORT:-8081}"
REPO_DIR="${REPO_DIR:-/opt/jenkins/repos/golem-century}"
LOG_DIR="${APP_DIR}/logs"
LOG_FILE="${LOG_DIR}/deploy-$(date +%Y%m%d-%H%M%S).log"

mkdir -p "${LOG_DIR}"
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Starting deployment" | tee -a "${LOG_FILE}"
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Branch: ${GIT_BRANCH}" | tee -a "${LOG_FILE}"
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Repository: ${REPO_DIR}" | tee -a "${LOG_FILE}"
echo "[$(date +'%Y-%m-%d %H:%M:%S')] App Directory: ${APP_DIR}" | tee -a "${LOG_FILE}"

# Check Docker
if ! command -v docker &gt;/dev/null 2&gt;&amp;1; then
  echo "ERROR: Docker not installed" | tee -a "${LOG_FILE}"
  exit 1
fi

if ! command -v docker-compose &gt;/dev/null 2&gt;&amp;1; then
  echo "ERROR: docker-compose not installed" | tee -a "${LOG_FILE}"
  exit 1
fi

# Verify repo directory exists
if [ ! -d "${REPO_DIR}" ]; then
  echo "ERROR: Repository directory not found: ${REPO_DIR}" | tee -a "${LOG_FILE}"
  exit 1
fi

# Verify docker-compose.yml exists
if [ ! -f "${REPO_DIR}/docker-compose.yml" ]; then
  echo "ERROR: docker-compose.yml not found in ${REPO_DIR}" | tee -a "${LOG_FILE}"
  exit 1
fi

# Create app directory and copy files
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Copying files to app directory..." | tee -a "${LOG_FILE}"
mkdir -p "${APP_DIR}"
rsync -av --delete --exclude='.git' "${REPO_DIR}/" "${APP_DIR}/" || {
  echo "ERROR: Failed to copy files from ${REPO_DIR} to ${APP_DIR}" | tee -a "${LOG_FILE}"
  exit 1
}

# Change to app directory
cd "${APP_DIR}" || exit 1

# Stop existing containers
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Stopping existing containers..." | tee -a "${LOG_FILE}"
docker-compose down || true

# Build and start
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Building and starting containers..." | tee -a "${LOG_FILE}"
if docker-compose up -d --build; then
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✓ Containers started" | tee -a "${LOG_FILE}"
else
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✗ Failed to start containers" | tee -a "${LOG_FILE}"
  docker-compose logs | tee -a "${LOG_FILE}"
  exit 1
fi

# Wait for containers
sleep 5

# Verify
{% raw %}
if docker ps --filter "name=${APP_NAME}-server" --format "{{.Status}}" | grep -q "Up"; then
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✓ Deployment successful" | tee -a "${LOG_FILE}"
  docker ps --filter "name=${APP_NAME}-server" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | tee -a "${LOG_FILE}"
else
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✗ Container not running" | tee -a "${LOG_FILE}"
  docker-compose logs | tee -a "${LOG_FILE}"
  exit 1
fi
{% endraw %}

echo "[$(date +'%Y-%m-%d %H:%M:%S')] Deployment completed" | tee -a "${LOG_FILE}"
SCRIPT_EOF
  chmod +x "${SCRIPTS_DIR}/deploy.sh"
  echo "Created deploy.sh script"
fi

# Run deployment
cd "${SCRIPTS_DIR}"
export APP_NAME="${APP_NAME}"
export APP_DIR="${APP_DIR}"
export APP_PORT="${APP_PORT}"
export GIT_REPO="${GIT_REPO}"
export GIT_BRANCH="${GIT_BRANCH}"
export REPO_DIR="${REPO_DIR}"
./deploy.sh

DEPLOY_SCRIPT

echo "Deployment completed successfully!"
</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>
